<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能点名系统</title>
    <style>
        :root {
            --primary-color: #2575fc;
            --secondary-color: #6a11cb;
            --background-color: rgba(255, 255, 255, 0.95);
            --text-color: #343a40;
            --section-bg: #f8f9fa;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --button-start: linear-gradient(to right, #00b09b, #96c93d);
            --button-reset: linear-gradient(to right, #8e2de2, #4a00e0);
            --button-running: linear-gradient(to right, #ff416c, #ff4b2b);
            --admin-bg: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            --user-bg: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            --transition-speed: 0.4s;
        }

        /* 深色模式变量 */
        .dark-mode {
            --primary-color: #4dabf7;
            --secondary-color: #9775fa;
            --background-color: rgba(30, 30, 40, 0.95);
            --text-color: #f1f3f5;
            --section-bg: #343a40;
            --border-color: #495057;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --button-start: linear-gradient(to right, #20c997, #51cf66);
            --button-reset: linear-gradient(to right, #845ef7, #5f3dc4);
            --button-running: linear-gradient(to right, #ff6b6b, #e03131);
            --admin-bg: linear-gradient(135deg, #0c1b33 0%, #1c5c5a 100%);
            --user-bg: linear-gradient(135deg, #3d0c6d 0%, #1a4fb3 100%);
        }

        /* 浅色模式变量 */
        .light-mode {
            --primary-color: #2575fc;
            --secondary-color: #6a11cb;
            --background-color: rgba(255, 255, 255, 0.95);
            --text-color: #343a40;
            --section-bg: #f8f9fa;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --button-start: linear-gradient(to right, #00b09b, #96c93d);
            --button-reset: linear-gradient(to right, #8e2de2, #4a00e0);
            --button-running: linear-gradient(to right, #ff416c, #ff4b2b);
            --admin-bg: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            --user-bg: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background: var(--user-bg);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-color);
            transition: background var(--transition-speed) ease;
        }
        
        body.admin-bg {
            background: var(--admin-bg);
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: var(--background-color);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            padding: 30px;
            transition: all var(--transition-speed) ease;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .header h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            transition: color var(--transition-speed) ease;
        }
        
        .header p {
            color: var(--secondary-color);
            font-size: 1.2rem;
            font-weight: 500;
            transition: color var(--transition-speed) ease;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .nickname {
            font-weight: bold;
            color: var(--text-color);
            font-size: 1.2rem;
            transition: color var(--transition-speed) ease;
        }
        
        .username {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.9rem;
            transition: color var(--transition-speed) ease;
        }
        
        .preferences {
            display: flex;
            gap: 10px;
            margin-left: 15px;
        }
        
        .preferences select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--background-color);
            color: var(--text-color);
            transition: all var(--transition-speed) ease;
        }
        
        .main-content {
            margin-bottom: 30px;
        }
        
        .section-title {
            color: var(--text-color);
            margin-bottom: 15px;
            font-size: 1.5rem;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            transition: color var(--transition-speed) ease;
        }
        
        .name-display {
            background: var(--section-bg);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: inset 0 0 10px var(--shadow-color);
            border: 2px solid var(--border-color);
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 15px;
            transition: all var(--transition-speed) ease;
        }
        
        .current-name {
            font-size: 3.5rem;
            font-weight: bold;
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        .selected {
            color: var(--primary-color);
            transform: scale(1.05);
            text-shadow: 0 0 10px rgba(37, 117, 252, 0.3);
            animation: pulse 0.5s ease;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1.05); }
        }
        
        .batch-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .batch-selector label {
            font-weight: bold;
        }
        
        .batch-selector select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--background-color);
            color: var(--text-color);
            transition: all var(--transition-speed) ease;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px var(--shadow-color);
            color: white;
        }
        
        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        
        .btn-start {
            background: var(--button-start);
        }
        
        .btn-start:hover {
            filter: brightness(0.9);
        }
        
        .btn-start.running {
            background: var(--button-running);
            animation: pulse 1s infinite;
        }
        
        .btn-reset {
            background: var(--button-reset);
        }
        
        .btn-reset:hover {
            filter: brightness(0.9);
        }
        
        .btn-menu {
            background: #6c757d;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .btn-menu:hover {
            background: #5a6268;
        }
        
        .history {
            background: var(--section-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 0 10px var(--shadow-color);
            border: 2px solid var(--border-color);
            transition: all var(--transition-speed) ease;
        }
        
        .history h2 {
            color: var(--text-color);
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.5rem;
            transition: color var(--transition-speed) ease;
        }
        
        .manual-add {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .manual-add select {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--background-color);
            color: var(--text-color);
            transition: all var(--transition-speed) ease;
        }
        
        .manual-add button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .selected-item {
            background: var(--primary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .remove-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }

        .remove-btn:hover {
            transform: scale(1.2);
        }
        
        .empty-history {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }
        
        .login-container {
            background: var(--background-color);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            transition: all var(--transition-speed) ease;
        }
        
        .login-title {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 30px;
            transition: color var(--transition-speed) ease;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            text-align: left;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
            transition: color var(--transition-speed) ease;
        }
        
        .username-input-group {
            display: flex;
            gap: 10px;
        }
        
        .username-input-group input {
            flex: 2;
        }
        
        .username-input-group select {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            background: var(--background-color);
            color: var(--text-color);
            transition: all var(--transition-speed) ease;
        }
        
        .form-group input {
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            font-size: 1rem;
            background: var(--background-color);
            color: var(--text-color);
            transition: all var(--transition-speed) ease;
        }
        
        .btn-login {
            background: var(--button-start);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-login:hover {
            filter: brightness(0.9);
        }
        
        .language-selector {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            margin-top: 20px;
            width: 100%;
            background: var(--background-color);
            color: var(--text-color);
            transition: all var(--transition-speed) ease;
        }
        
        .theme-selector {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            margin-top: 10px;
            width: 100%;
            background: var(--background-color);
            color: var(--text-color);
            transition: all var(--transition-speed) ease;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--background-color);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all var(--transition-speed) ease;
            animation: scaleIn 0.3s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--text-color);
            transition: color var(--transition-speed) ease;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: var(--primary-color);
        }
        
        .list-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .list-controls select {
            flex: 2;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            font-size: 1rem;
            background: var(--background-color);
            color: var(--text-color);
            transition: all var(--transition-speed) ease;
        }
        
        .list-controls button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: #6c757d;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .list-controls button:hover {
            background: #5a6268;
        }
        
        .list-editor {
            background: var(--section-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 0 10px var(--shadow-color);
            border: 2px solid var(--border-color);
            margin-bottom: 20px;
            transition: all var(--transition-speed) ease;
        }
        
        .list-editor h3 {
            margin-bottom: 15px;
            color: var(--text-color);
            transition: color var(--transition-speed) ease;
        }
        
        .list-name-input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            margin-bottom: 15px;
            font-size: 1rem;
            background: var(--background-color);
            color: var(--text-color);
            transition: all var(--transition-speed) ease;
        }
        
        .names-input {
            width: 100%;
            height: 150px;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            margin-bottom: 15px;
            font-size: 1rem;
            resize: vertical;
            background: var(--background-color);
            color: var(--text-color);
            transition: all var(--transition-speed) ease;
        }
        
        .editor-buttons {
            display: flex;
            gap: 10px;
        }
        
        .editor-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-save {
            background: #28a745;
            color: white;
        }
        
        .btn-save:hover {
            background: #218838;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .user-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            transition: all var(--transition-speed) ease;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-nickname {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .setting-label {
            font-weight: bold;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .current-name {
                font-size: 2.5rem;
            }
            
            .btn {
                font-size: 1rem;
                padding: 12px;
            }
            
            .preferences {
                flex-direction: column;
                width: 100%;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body class="light-mode">
    <!-- 登录界面 -->
    <div class="login-container" id="loginContainer">
        <h1 class="login-title" id="loginTitle">智能点名系统</h1>
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="username" id="usernameLabel">用户名</label>
                <div class="username-input-group">
                    <input type="text" id="username" required>
                    <select id="usernameSelector">
                        <option value="">选择用户</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="password" id="passwordLabel">密码</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="btn-login" id="loginButton">登录</button>
            <select class="language-selector" id="languageSelector">
                <option value="zh">中文</option>
                <option value="en">English</option>
                <option value="es">Español</option>
            </select>
            <select class="theme-selector" id="themeSelector">
                <option value="auto">跟随系统</option>
                <option value="light">浅色模式</option>
                <option value="dark">深色模式</option>
            </select>
        </form>
    </div>

    <!-- 主应用界面 -->
    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <div>
                <h1 id="appTitle">智能点名系统</h1>
                <p id="creatorText">制作者：Jerry Fu</p>
            </div>
            <div class="user-info">
                <div class="user-display">
                    <div class="nickname" id="currentNickname">昵称</div>
                    <div class="username" id="currentUsername">用户名</div>
                </div>
                <div class="preferences">
                    <select id="mainLanguageSelector">
                        <option value="zh">中文</option>
                        <option value="en">English</option>
                        <option value="es">Español</option>
                    </select>
                    <select id="mainThemeSelector">
                        <option value="auto">跟随系统</option>
                        <option value="light">浅色</option>
                        <option value="dark">深色</option>
                    </select>
                </div>
                <button class="btn-menu" id="settingsBtn" style="display: none;">设置</button>
                <button class="btn-menu" id="listManagerBtn">名单管理</button>
                <button class="btn-menu" id="logoutBtn">退出</button>
            </div>
        </div>
        
        <div class="main-content">
            <h2 class="section-title" id="rollSectionTitle">点名区域</h2>
            
            <div class="name-display">
                <div class="current-name" id="currentName">准备开始</div>
                <div class="batch-selector">
                    <label for="batchCount" id="batchLabel">一次性抽取：</label>
                    <select id="batchCount">
                        <option value="1">1名学生</option>
                        <option value="2">2名学生</option>
                        <option value="3">3名学生</option>
                        <option value="5">5名学生</option>
                    </select>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-start" id="startBtn">开始点名</button>
                <button class="btn btn-reset" id="resetBtn">重置名单</button>
            </div>
            
            <div class="history">
                <h2 id="historyTitle">已选名单</h2>
                <div class="manual-add">
                    <select id="manualNameSelect">
                        <option value="">选择学生</option>
                    </select>
                    <button id="manualAddBtn">添加</button>
                </div>
                <div class="selected-list" id="selectedList">
                    <div class="empty-history" id="emptyHistory">暂无已选人员</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 名单管理模态框 -->
    <div class="modal" id="listManagerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="listManagerTitle">名单管理</h2>
                <button class="close-btn" id="closeListManagerBtn">&times;</button>
            </div>
            
            <div class="list-controls">
                <select id="listSelector">
                    <option value="" id="selectListOption">-- 选择名单 --</option>
                </select>
                <button id="newListBtn">新建名单</button>
            </div>
            
            <div class="list-editor">
                <h3 id="editorTitle">编辑名单</h3>
                <input type="text" id="listNameInput" class="list-name-input" placeholder="输入名单名称">
                <textarea id="namesInput" class="names-input" placeholder="输入姓名，每行一个"></textarea>
                <div class="editor-buttons">
                    <button id="saveListBtn" class="btn-save">保存名单</button>
                    <button id="deleteListBtn" class="btn-delete">删除名单</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户设置模态框 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="settingsTitle">用户设置</h2>
                <button class="close-btn" id="closeSettingsBtn">&times;</button>
            </div>
            
            <div id="userSettings">
                <div class="form-group">
                    <label for="nicknameInput" id="nicknameLabel">昵称</label>
                    <input type="text" id="nicknameInput">
                </div>
                <div class="form-group">
                    <label for="changeUsernameInput" id="changeUsernameLabel">用户名</label>
                    <input type="text" id="changeUsernameInput">
                </div>
                <div class="form-group">
                    <label for="changePasswordInput" id="changePasswordLabel">新密码</label>
                    <input type="password" id="changePasswordInput">
                </div>
                
                <div class="setting-item">
                    <span class="setting-label" id="spaceShortcutLabel">空格键快捷点名</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="spaceShortcutToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <button class="btn-save" id="saveUserSettingsBtn" style="width: 100%; margin-bottom: 20px;">保存设置</button>
            </div>
            
            <div id="adminSettings" style="display: none;">
                <h3 id="userManagementTitle">用户管理</h3>
                <div class="form-group">
                    <label for="newUsername" id="newUsernameLabel">新用户名</label>
                    <input type="text" id="newUsername">
                </div>
                <div class="form-group">
                    <label for="newPassword" id="newPasswordLabel">初始密码</label>
                    <input type="password" id="newPassword" value="000000" readonly>
                </div>
                <button class="btn-save" id="addUserBtn" style="width: 100%; margin-bottom: 20px;">添加用户</button>
                
                <div class="user-list">
                    <h3 id="userListTitle">用户列表</h3>
                    <div id="userListContainer">
                        <!-- 用户列表将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 多语言文本
        const translations = {
            zh: {
                // 登录界面
                loginTitle: "智能点名系统",
                usernameLabel: "用户名",
                passwordLabel: "密码",
                loginButton: "登录",
                selectUser: "选择用户",
                
                // 主界面
                appTitle: "智能点名系统",
                creatorText: "制作者：Jerry Fu",
                rollSectionTitle: "点名区域",
                startBtn: "开始点名",
                resetBtn: "重置名单",
                historyTitle: "已选名单",
                emptyHistory: "暂无已选人员",
                listManagerBtn: "名单管理",
                settingsBtn: "设置",
                logoutBtn: "退出",
                batchLabel: "一次性抽取：",
                manualPlaceholder: "选择学生",
                manualAddBtn: "添加",
                spaceShortcutLabel: "空格键快捷点名",
                
                // 名单管理界面
                listManagerTitle: "名单管理",
                selectListOption: "-- 选择名单 --",
                newListBtn: "新建名单",
                editorTitle: "编辑名单",
                listNamePlaceholder: "输入名单名称",
                namesPlaceholder: "输入姓名，每行一个",
                saveListBtn: "保存名单",
                deleteListBtn: "删除名单",
                
                // 用户设置界面
                settingsTitle: "用户设置",
                nicknameLabel: "昵称",
                changeUsernameLabel: "用户名",
                changePasswordLabel: "新密码",
                saveUserSettingsBtn: "保存设置",
                userManagementTitle: "用户管理",
                newUsernameLabel: "新用户名",
                newPasswordLabel: "初始密码",
                addUserBtn: "添加用户",
                userListTitle: "用户列表",
                deleteUserBtn: "删除",
                resetPasswordBtn: "重置密码",
                
                // 状态文本
                readyText: "准备开始",
                allSelectedText: "所有人已选完",
                pleaseSelectList: "请选择名单",
                confirmDeleteUser: "确定要删除用户吗？",
                userAdded: "用户添加成功",
                userExists: "用户已存在",
                fillAllFields: "请填写所有字段",
                listSaved: "名单保存成功",
                listDeleted: "名单已删除",
                selectListFirst: "请先选择名单",
                confirmDeleteList: "确定要删除名单吗？",
                settingsSaved: "设置保存成功",
                usernameExists: "用户名已存在",
                confirmResetPassword: "确定要将用户密码重置为000000吗？",
                passwordReset: "密码已重置",
                studentAdded: "学生已添加到已选名单",
                studentExists: "该学生已在已选名单中",
                enterStudentName: "请选择学生",
                batchSelection: "批量选择",
                themeAuto: "跟随系统",
                themeLight: "浅色模式",
                themeDark: "深色模式"
            },
            en: {
                loginTitle: "Smart Roll Call",
                usernameLabel: "Username",
                passwordLabel: "Password",
                loginButton: "Login",
                selectUser: "Select User",
                
                appTitle: "Smart Roll Call",
                creatorText: "Creator: Jerry Fu",
                rollSectionTitle: "Roll Call Area",
                startBtn: "Start Roll Call",
                resetBtn: "Reset List",
                historyTitle: "Selected Names",
                emptyHistory: "No one selected yet",
                listManagerBtn: "List Management",
                settingsBtn: "Settings",
                logoutBtn: "Logout",
                batchLabel: "Select at once:",
                manualPlaceholder: "Select student",
                manualAddBtn: "Add",
                spaceShortcutLabel: "Spacebar Shortcut",
                
                listManagerTitle: "List Management",
                selectListOption: "-- Select List --",
                newListBtn: "New List",
                editorTitle: "Edit List",
                listNamePlaceholder: "Enter list name",
                namesPlaceholder: "Enter names, one per line",
                saveListBtn: "Save List",
                deleteListBtn: "Delete List",
                
                settingsTitle: "User Settings",
                nicknameLabel: "Nickname",
                changeUsernameLabel: "Username",
                changePasswordLabel: "New Password",
                saveUserSettingsBtn: "Save Settings",
                userManagementTitle: "User Management",
                newUsernameLabel: "New Username",
                newPasswordLabel: "Initial Password",
                addUserBtn: "Add User",
                userListTitle: "User List",
                deleteUserBtn: "Delete",
                resetPasswordBtn: "Reset Password",
                
                readyText: "Ready to start",
                allSelectedText: "All people selected",
                pleaseSelectList: "Please select a list",
                confirmDeleteUser: "Are you sure you want to delete this user?",
                userAdded: "User added successfully",
                userExists: "User already exists",
                fillAllFields: "Please fill all fields",
                listSaved: "List saved successfully",
                listDeleted: "List deleted",
                selectListFirst: "Please select a list first",
                confirmDeleteList: "Are you sure you want to delete this list?",
                settingsSaved: "Settings saved successfully",
                usernameExists: "Username already exists",
                confirmResetPassword: "Are you sure you want to reset the password to 000000?",
                passwordReset: "Password has been reset",
                studentAdded: "Student added to selected list",
                studentExists: "Student already in selected list",
                enterStudentName: "Please select a student",
                batchSelection: "Batch selection",
                themeAuto: "Follow System",
                themeLight: "Light Mode",
                themeDark: "Dark Mode"
            },
            es: {
                loginTitle: "Sistema Inteligente",
                usernameLabel: "Usuario",
                passwordLabel: "Contraseña",
                loginButton: "Iniciar Sesión",
                selectUser: "Seleccionar Usuario",
                
                appTitle: "Sistema Inteligente",
                creatorText: "Creador: Jerry Fu",
                rollSectionTitle: "Área de Llamada",
                startBtn: "Comenzar Llamada",
                resetBtn: "Reiniciar Lista",
                historyTitle: "Nombres Seleccionados",
                emptyHistory: "Nadie seleccionado aún",
                listManagerBtn: "Gestión de Listas",
                settingsBtn: "Configuración",
                logoutBtn: "Cerrar Sesión",
                batchLabel: "Seleccionar a la vez:",
                manualPlaceholder: "Seleccionar estudiante",
                manualAddBtn: "Agregar",
                spaceShortcutLabel: "Atajo de Barra Espaciadora",
                
                listManagerTitle: "Gestión de Listas",
                selectListOption: "-- Seleccionar Lista --",
                newListBtn: "Nueva Lista",
                editorTitle: "Editar Lista",
                listNamePlaceholder: "Ingrese nombre de lista",
                namesPlaceholder: "Ingrese nombres, uno por línea",
                saveListBtn: "Guardar Lista",
                deleteListBtn: "Eliminar Lista",
                
                settingsTitle: "Configuración de Usuario",
                nicknameLabel: "Apodo",
                changeUsernameLabel: "Usuario",
                changePasswordLabel: "Nueva Contraseña",
                saveUserSettingsBtn: "Guardar Configuración",
                userManagementTitle: "Gestión de Usuarios",
                newUsernameLabel: "Nuevo Usuario",
                newPasswordLabel: "Contraseña Inicial",
                addUserBtn: "Agregar Usuario",
                userListTitle: "Lista de Usuarios",
                deleteUserBtn: "Eliminar",
                resetPasswordBtn: "Restablecer Contraseña",
                
                readyText: "Listo para comenzar",
                allSelectedText: "Todas las personas seleccionadas",
                pleaseSelectList: "Por favor seleccione una lista",
                confirmDeleteUser: "¿Está seguro de que desea eliminar este usuario?",
                userAdded: "Usuario agregado exitosamente",
                userExists: "El usuario ya existe",
                fillAllFields: "Por favor complete todos los campos",
                listSaved: "Lista guardada exitosamente",
                listDeleted: "Lista eliminada",
                selectListFirst: "Por favor seleccione una lista primero",
                confirmDeleteList: "¿Está seguro de que desea eliminar esta lista?",
                settingsSaved: "Configuración guardada exitosamente",
                usernameExists: "El nombre de usuario ya existe",
                confirmResetPassword: "¿Está seguro de que desea restablecer la contraseña a 000000?",
                passwordReset: "Contraseña restablecida",
                studentAdded: "Estudiante agregado a la lista seleccionada",
                studentExists: "El estudiante ya está en la lista seleccionada",
                enterStudentName: "Por favor seleccione un estudiante",
                batchSelection: "Selección por lotes",
                themeAuto: "Seguir Sistema",
                themeLight: "Modo Claro",
                themeDark: "Modo Oscuro"
            }
        };

        // 获取DOM元素
        const loginContainer = document.getElementById('loginContainer');
        const mainContainer = document.getElementById('mainContainer');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const usernameSelector = document.getElementById('usernameSelector');
        const languageSelector = document.getElementById('languageSelector');
        const themeSelector = document.getElementById('themeSelector');
        
        const currentNicknameElement = document.getElementById('currentNickname');
        const currentUsernameElement = document.getElementById('currentUsername');
        const mainLanguageSelector = document.getElementById('mainLanguageSelector');
        const mainThemeSelector = document.getElementById('mainThemeSelector');
        const settingsBtn = document.getElementById('settingsBtn');
        const listManagerBtn = document.getElementById('listManagerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        const listManagerModal = document.getElementById('listManagerModal');
        const closeListManagerBtn = document.getElementById('closeListManagerBtn');
        const listSelector = document.getElementById('listSelector');
        const newListBtn = document.getElementById('newListBtn');
        const listNameInput = document.getElementById('listNameInput');
        const namesInput = document.getElementById('namesInput');
        const saveListBtn = document.getElementById('saveListBtn');
        const deleteListBtn = document.getElementById('deleteListBtn');
        
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const nicknameInput = document.getElementById('nicknameInput');
        const changeUsernameInput = document.getElementById('changeUsernameInput');
        const changePasswordInput = document.getElementById('changePasswordInput');
        const saveUserSettingsBtn = document.getElementById('saveUserSettingsBtn');
        const spaceShortcutToggle = document.getElementById('spaceShortcutToggle');
        
        const adminSettings = document.getElementById('adminSettings');
        const newUsernameInput = document.getElementById('newUsername');
        const newPasswordInput = document.getElementById('newPassword');
        const addUserBtn = document.getElementById('addUserBtn');
        const userListContainer = document.getElementById('userListContainer');
        
        const currentNameElement = document.getElementById('currentName');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const selectedListElement = document.getElementById('selectedList');
        const batchCountSelector = document.getElementById('batchCount');
        const manualNameSelect = document.getElementById('manualNameSelect');
        const manualAddBtn = document.getElementById('manualAddBtn');

        // 状态变量
        let isRunning = false;
        let intervalId = null;
        let availableStudents = [];
        let selectedStudents = [];
        let currentListName = '';
        let currentLanguage = 'zh';
        let currentUser = null;
        let isAdmin = false;
        let currentTheme = 'auto';
        let spaceShortcutEnabled = true;

        // 初始化应用
        function init() {
            // 设置默认管理员账户
            if (!localStorage.getItem('users')) {
                const users = {
                    'jf02134915': {
                        password: 'abnormal',
                        isAdmin: true,
                        nickname: '管理员',
                        spaceShortcutEnabled: true,
                        lists: {
                            "班级A": ["张三", "李四", "王五", "赵六", "钱七"],
                            "班级B": ["小明", "小红", "小刚", "小丽", "小华"]
                        }
                    }
                };
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // 加载主题设置
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                currentTheme = savedTheme;
                themeSelector.value = savedTheme;
                mainThemeSelector.value = savedTheme;
                applyTheme(savedTheme);
            }
            
            // 加载空格键快捷功能设置
            const savedSpaceShortcut = localStorage.getItem('spaceShortcutEnabled');
            if (savedSpaceShortcut !== null) {
                spaceShortcutEnabled = savedSpaceShortcut === 'true';
                spaceShortcutToggle.checked = spaceShortcutEnabled;
            }
            
            // 更新用户名选择器
            updateUsernameSelector();
            
            // 设置语言
            updateLanguage();
            
            // 添加事件监听
            loginForm.addEventListener('submit', handleLogin);
            languageSelector.addEventListener('change', handleLanguageChange);
            mainLanguageSelector.addEventListener('change', handleMainLanguageChange);
            themeSelector.addEventListener('change', handleThemeChange);
            mainThemeSelector.addEventListener('change', handleMainThemeChange);
            usernameSelector.addEventListener('change', handleUsernameSelect);
            listManagerBtn.addEventListener('click', showListManager);
            closeListManagerBtn.addEventListener('click', closeListManager);
            settingsBtn.addEventListener('click', showSettings);
            logoutBtn.addEventListener('click', handleLogout);
            closeSettingsBtn.addEventListener('click', closeSettings);
            saveUserSettingsBtn.addEventListener('click', saveUserSettings);
            addUserBtn.addEventListener('click', addUser);
            manualAddBtn.addEventListener('click', addManualStudent);
            spaceShortcutToggle.addEventListener('change', toggleSpaceShortcut);
            
            startBtn.addEventListener('click', toggleRollCall);
            resetBtn.addEventListener('click', resetList);
            newListBtn.addEventListener('click', newList);
            saveListBtn.addEventListener('click', saveList);
            deleteListBtn.addEventListener('click', deleteList);
            
            listSelector.addEventListener('change', function() {
                const selectedList = this.value;
                if (selectedList) {
                    listNameInput.value = selectedList;
                    const users = JSON.parse(localStorage.getItem('users'));
                    const currentUserData = users[currentUser];
                    
                    // 检查是否是管理员查看其他用户的名单
                    if (selectedList.includes(' - ')) {
                        const [owner, listName] = selectedList.split(' - ');
                        namesInput.value = users[owner].lists[listName].join('\n');
                    } else {
                        namesInput.value = currentUserData.lists[selectedList].join('\n');
                    }
                    
                    selectList(selectedList);
                } else {
                    newList();
                }
            });
            
            // 添加空格键事件监听
            document.addEventListener('keydown', handleKeyDown);
        }

        // 处理键盘事件
        function handleKeyDown(e) {
            // 检查是否启用了空格键快捷功能
            if (!spaceShortcutEnabled) return;
            
            // 检查是否按下了空格键
            if (e.code === 'Space') {
                // 阻止默认行为（滚动页面）
                e.preventDefault();
                
                // 只有在主界面显示且当前名单已选择时才响应
                if (mainContainer.style.display !== 'none' && currentListName) {
                    toggleRollCall();
                }
            }
        }

        // 切换空格键快捷功能
        function toggleSpaceShortcut() {
            spaceShortcutEnabled = spaceShortcutToggle.checked;
            localStorage.setItem('spaceShortcutEnabled', spaceShortcutEnabled);
            
            // 更新用户数据
            const users = JSON.parse(localStorage.getItem('users'));
            if (users[currentUser]) {
                users[currentUser].spaceShortcutEnabled = spaceShortcutEnabled;
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        // 更新用户名选择器
        function updateUsernameSelector() {
            const users = JSON.parse(localStorage.getItem('users'));
            usernameSelector.innerHTML = '<option value="">选择用户</option>';
            
            for (const username in users) {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = `${username} (${users[username].nickname || '无昵称'})`;
                usernameSelector.appendChild(option);
            }
        }

        // 处理用户名选择
        function handleUsernameSelect() {
            const selectedUsername = this.value;
            if (selectedUsername) {
                usernameInput.value = selectedUsername;
            }
        }

        // 处理登录
        function handleLogin(e) {
            e.preventDefault();
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            const users = JSON.parse(localStorage.getItem('users'));
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                isAdmin = users[username].isAdmin || false;
                
                // 加载用户设置
                spaceShortcutEnabled = users[username].spaceShortcutEnabled !== undefined ? 
                    users[username].spaceShortcutEnabled : true;
                spaceShortcutToggle.checked = spaceShortcutEnabled;
                
                // 更新背景（管理员特殊背景）
                if (isAdmin) {
                    document.body.classList.add('admin-bg');
                } else {
                    document.body.classList.remove('admin-bg');
                }
                
                // 显示主界面
                loginContainer.style.display = 'none';
                mainContainer.style.display = 'block';
                
                // 清空名单管理输入框，防止隐私泄漏
                listNameInput.value = '';
                namesInput.value = '';
                
                // 重置点名显示
                currentNameElement.textContent = translations[currentLanguage].readyText;
                
                // 更新界面
                updateUserInterface();
                updateListSelector();
                
                // 显示设置按钮（仅管理员）
                settingsBtn.style.display = isAdmin ? 'block' : 'none';
            } else {
                alert(currentLanguage === 'zh' ? '用户名或密码错误' : 
                      currentLanguage === 'en' ? 'Invalid username or password' : 
                      'Usuario o contraseña incorrectos');
            }
        }

        // 处理退出
        function handleLogout() {
            // 清空名单管理输入框，防止隐私泄漏
            listNameInput.value = '';
            namesInput.value = '';
            
            // 清空当前显示的名字
            currentNameElement.textContent = '';
            
            currentUser = null;
            isAdmin = false;
            document.body.classList.remove('admin-bg');
            mainContainer.style.display = 'none';
            loginContainer.style.display = 'block';
            usernameInput.value = '';
            passwordInput.value = '';
            
            // 更新用户名选择器
            updateUsernameSelector();
        }

        // 更新用户界面
        function updateUserInterface() {
            const users = JSON.parse(localStorage.getItem('users'));
            const currentUserData = users[currentUser];
            
            // 显示昵称和用户名
            currentNicknameElement.textContent = currentUserData.nickname || currentUser;
            currentUsernameElement.textContent = currentUser;
            
            updateLanguage();
        }

        // 处理语言切换
        function handleLanguageChange() {
            currentLanguage = languageSelector.value;
            updateLanguage();
        }

        // 处理主页语言切换
        function handleMainLanguageChange() {
            currentLanguage = mainLanguageSelector.value;
            updateLanguage();
        }

        // 处理主题切换
        function handleThemeChange() {
            currentTheme = themeSelector.value;
            localStorage.setItem('theme', currentTheme);
            applyTheme(currentTheme);
        }

        // 处理主页主题切换
        function handleMainThemeChange() {
            currentTheme = mainThemeSelector.value;
            localStorage.setItem('theme', currentTheme);
            applyTheme(currentTheme);
        }

        // 应用主题
        function applyTheme(theme) {
            document.body.classList.remove('light-mode', 'dark-mode');
            
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (theme === 'light') {
                document.body.classList.add('light-mode');
            } else {
                // 跟随系统
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.add('light-mode');
                }
            }
            
            // 同步主题选择器
            themeSelector.value = theme;
            mainThemeSelector.value = theme;
        }

        // 更新语言
        function updateLanguage() {
            const lang = translations[currentLanguage];
            
            // 同步语言选择器
            languageSelector.value = currentLanguage;
            mainLanguageSelector.value = currentLanguage;
            
            // 更新登录界面
            document.getElementById('loginTitle').textContent = lang.loginTitle;
            document.getElementById('usernameLabel').textContent = lang.usernameLabel;
            document.getElementById('passwordLabel').textContent = lang.passwordLabel;
            document.getElementById('loginButton').textContent = lang.loginButton;
            usernameSelector.querySelector('option').textContent = lang.selectUser;
            
            // 更新主界面
            document.getElementById('appTitle').textContent = lang.appTitle;
            document.getElementById('creatorText').textContent = lang.creatorText;
            document.getElementById('rollSectionTitle').textContent = lang.rollSectionTitle;
            startBtn.textContent = lang.startBtn;
            resetBtn.textContent = lang.resetBtn;
            document.getElementById('historyTitle').textContent = lang.historyTitle;
            document.getElementById('emptyHistory').textContent = lang.emptyHistory;
            listManagerBtn.textContent = lang.listManagerBtn;
            settingsBtn.textContent = lang.settingsBtn;
            logoutBtn.textContent = lang.logoutBtn;
            document.getElementById('batchLabel').textContent = lang.batchLabel;
            manualNameSelect.querySelector('option').textContent = lang.manualPlaceholder;
            manualAddBtn.textContent = lang.manualAddBtn;
            
            // 更新名单管理界面
            document.getElementById('listManagerTitle').textContent = lang.listManagerTitle;
            document.getElementById('selectListOption').textContent = lang.selectListOption;
            newListBtn.textContent = lang.newListBtn;
            document.getElementById('editorTitle').textContent = lang.editorTitle;
            listNameInput.placeholder = lang.listNamePlaceholder;
            namesInput.placeholder = lang.namesPlaceholder;
            saveListBtn.textContent = lang.saveListBtn;
            deleteListBtn.textContent = lang.deleteListBtn;
            
            // 更新用户设置界面
            document.getElementById('settingsTitle').textContent = lang.settingsTitle;
            document.getElementById('nicknameLabel').textContent = lang.nicknameLabel;
            document.getElementById('changeUsernameLabel').textContent = lang.changeUsernameLabel;
            document.getElementById('changePasswordLabel').textContent = lang.changePasswordLabel;
            saveUserSettingsBtn.textContent = lang.saveUserSettingsBtn;
            document.getElementById('spaceShortcutLabel').textContent = lang.spaceShortcutLabel;
            document.getElementById('userManagementTitle').textContent = lang.userManagementTitle;
            document.getElementById('newUsernameLabel').textContent = lang.newUsernameLabel;
            document.getElementById('newPasswordLabel').textContent = lang.newPasswordLabel;
            addUserBtn.textContent = lang.addUserBtn;
            document.getElementById('userListTitle').textContent = lang.userListTitle;
            
            // 更新主题选择器选项
            themeSelector.querySelector('option[value="auto"]').textContent = lang.themeAuto;
            themeSelector.querySelector('option[value="light"]').textContent = lang.themeLight;
            themeSelector.querySelector('option[value="dark"]').textContent = lang.themeDark;
            
            mainThemeSelector.querySelector('option[value="auto"]').textContent = lang.themeAuto;
            mainThemeSelector.querySelector('option[value="light"]').textContent = lang.themeLight;
            mainThemeSelector.querySelector('option[value="dark"]').textContent = lang.themeDark;
            
            // 更新状态文本
            if (currentNameElement.textContent === translations['zh'].readyText || 
                currentNameElement.textContent === translations['en'].readyText ||
                currentNameElement.textContent === translations['es'].readyText) {
                currentNameElement.textContent = lang.readyText;
            }
            
            if (currentNameElement.textContent === translations['zh'].allSelectedText || 
                currentNameElement.textContent === translations['en'].allSelectedText ||
                currentNameElement.textContent === translations['es'].allSelectedText) {
                currentNameElement.textContent = lang.allSelectedText;
            }
            
            if (currentNameElement.textContent === translations['zh'].pleaseSelectList || 
                currentNameElement.textContent === translations['en'].pleaseSelectList ||
                currentNameElement.textContent === translations['es'].pleaseSelectList) {
                currentNameElement.textContent = lang.pleaseSelectList;
            }
        }

        // 显示名单管理
        function showListManager() {
            updateListSelector();
            listManagerModal.style.display = 'flex';
        }

        // 关闭名单管理
        function closeListManager() {
            listManagerModal.style.display = 'none';
        }

        // 显示设置
        function showSettings() {
            const users = JSON.parse(localStorage.getItem('users'));
            const currentUserData = users[currentUser];
            
            // 填充当前用户设置
            nicknameInput.value = currentUserData.nickname || '';
            changeUsernameInput.value = currentUser;
            changePasswordInput.value = '';
            
            // 如果是管理员，显示用户管理部分
            if (isAdmin) {
                adminSettings.style.display = 'block';
                updateUserList();
            } else {
                adminSettings.style.display = 'none';
            }
            
            settingsModal.style.display = 'flex';
        }

        // 关闭设置
        function closeSettings() {
            settingsModal.style.display = 'none';
            newUsernameInput.value = '';
        }

        // 保存用户设置
        function saveUserSettings() {
            const users = JSON.parse(localStorage.getItem('users'));
            const currentUserData = users[currentUser];
            
            const newNickname = nicknameInput.value.trim();
            const newUsername = changeUsernameInput.value.trim();
            const newPassword = changePasswordInput.value.trim();
            
            // 检查用户名是否已存在（如果不是当前用户名）
            if (newUsername !== currentUser && users[newUsername]) {
                alert(translations[currentLanguage].usernameExists);
                return;
            }
            
            // 更新用户数据
            if (newNickname) {
                currentUserData.nickname = newNickname;
            }
            
            if (newPassword) {
                currentUserData.password = newPassword;
            }
            
            // 更新空格键设置
            currentUserData.spaceShortcutEnabled = spaceShortcutEnabled;
            
            // 如果用户名改变了
            if (newUsername !== currentUser) {
                // 删除旧用户，创建新用户
                delete users[currentUser];
                users[newUsername] = currentUserData;
                currentUser = newUsername;
            }
            
            localStorage.setItem('users', JSON.stringify(users));
            alert(translations[currentLanguage].settingsSaved);
            
            // 更新界面
            updateUserInterface();
            updateUsernameSelector();
            closeSettings();
        }

        // 更新用户列表
        function updateUserList() {
            const users = JSON.parse(localStorage.getItem('users'));
            userListContainer.innerHTML = '';
            
            for (const username in users) {
                if (username === currentUser) continue; // 跳过当前用户
                
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const userDetails = document.createElement('div');
                userDetails.className = 'user-details';
                
                const userName = document.createElement('span');
                userName.textContent = username;
                
                const userNickname = document.createElement('span');
                userNickname.className = 'user-nickname';
                userNickname.textContent = users[username].nickname || '';
                
                userDetails.appendChild(userName);
                userDetails.appendChild(userNickname);
                
                const userActions = document.createElement('div');
                
                const resetPasswordBtn = document.createElement('button');
                resetPasswordBtn.className = 'btn-save';
                resetPasswordBtn.textContent = translations[currentLanguage].resetPasswordBtn;
                resetPasswordBtn.addEventListener('click', function() {
                    if (confirm(translations[currentLanguage].confirmResetPassword)) {
                        users[username].password = '000000';
                        localStorage.setItem('users', JSON.stringify(users));
                        alert(translations[currentLanguage].passwordReset);
                    }
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete';
                deleteBtn.textContent = translations[currentLanguage].deleteUserBtn;
                deleteBtn.addEventListener('click', function() {
                    if (confirm(translations[currentLanguage].confirmDeleteUser)) {
                        delete users[username];
                        localStorage.setItem('users', JSON.stringify(users));
                        updateUserList();
                        updateUsernameSelector();
                    }
                });
                
                userActions.appendChild(resetPasswordBtn);
                userActions.appendChild(deleteBtn);
                
                userItem.appendChild(userDetails);
                userItem.appendChild(userActions);
                userListContainer.appendChild(userItem);
            }
        }

        // 添加用户
        function addUser() {
            const username = newUsernameInput.value.trim();
            
            if (!username) {
                alert(translations[currentLanguage].fillAllFields);
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users'));
            
            if (users[username]) {
                alert(translations[currentLanguage].userExists);
                return;
            }
            
            users[username] = {
                password: '000000',
                isAdmin: false,
                nickname: '',
                spaceShortcutEnabled: true,
                lists: {}
            };
            
            localStorage.setItem('users', JSON.stringify(users));
            alert(translations[currentLanguage].userAdded);
            newUsernameInput.value = '';
            updateUserList();
            updateUsernameSelector();
        }

        // 更新手动添加学生选择器
        function updateManualStudentSelector() {
            manualNameSelect.innerHTML = `<option value="">${translations[currentLanguage].manualPlaceholder}</option>`;
            
            if (!currentListName) return;
            
            const users = JSON.parse(localStorage.getItem('users'));
            let studentList = [];
            
            // 检查是否是管理员查看其他用户的名单
            if (currentListName.includes(' - ')) {
                const [owner, actualListName] = currentListName.split(' - ');
                studentList = users[owner].lists[actualListName];
            } else {
                const currentUserData = users[currentUser];
                studentList = currentUserData.lists[currentListName];
            }
            
            // 只显示尚未被选中的学生
            studentList.forEach(student => {
                if (!selectedStudents.includes(student)) {
                    const option = document.createElement('option');
                    option.value = student;
                    option.textContent = student;
                    manualNameSelect.appendChild(option);
                }
            });
        }

        // 手动添加学生到已选名单
        function addManualStudent() {
            const studentName = manualNameSelect.value;
            
            if (!studentName) {
                alert(translations[currentLanguage].enterStudentName);
                return;
            }
            
            // 检查是否已在已选名单中
            if (selectedStudents.includes(studentName)) {
                alert(translations[currentLanguage].studentExists);
                return;
            }
            
            // 添加到已选名单
            selectedStudents.push(studentName);
            
            // 从可用名单中移除
            const index = availableStudents.indexOf(studentName);
            if (index > -1) {
                availableStudents.splice(index, 1);
            }
            
            // 更新UI
            updateSelectedList();
            updateManualStudentSelector();
            
            alert(translations[currentLanguage].studentAdded);
        }

        // 从已选名单中移除学生
        function removeStudent(studentName) {
            const index = selectedStudents.indexOf(studentName);
            if (index > -1) {
                selectedStudents.splice(index, 1);
                
                // 如果该学生在原名单中，则重新添加到可用名单
                const users = JSON.parse(localStorage.getItem('users'));
                if (currentListName.includes(' - ')) {
                    const [owner, actualListName] = currentListName.split(' - ');
                    if (users[owner].lists[actualListName].includes(studentName)) {
                        availableStudents.push(studentName);
                    }
                } else {
                    const currentUserData = users[currentUser];
                    if (currentUserData.lists[currentListName].includes(studentName)) {
                        availableStudents.push(studentName);
                    }
                }
                
                updateSelectedList();
                updateManualStudentSelector();
            }
        }

        // 更新名单选择器
        function updateListSelector() {
            const users = JSON.parse(localStorage.getItem('users'));
            const currentUserData = users[currentUser];
            
            listSelector.innerHTML = `<option value="">${translations[currentLanguage].selectListOption}</option>`;
            
            // 添加当前用户的名单
            for (const listName in currentUserData.lists) {
                const option = document.createElement('option');
                option.value = listName;
                option.textContent = listName;
                listSelector.appendChild(option);
            }
            
            // 如果是管理员，添加其他用户的名单（带有用户名前缀）
            if (isAdmin) {
                for (const username in users) {
                    if (username === currentUser) continue; // 跳过当前用户
                    
                    const userLists = users[username].lists;
                    for (const listName in userLists) {
                        const option = document.createElement('option');
                        option.value = `${username} - ${listName}`;
                        option.textContent = `${listName} (${users[username].nickname || username})`;
                        listSelector.appendChild(option);
                    }
                }
            }
        }

        // 选择名单
        function selectList(listName) {
            if (!listName) {
                currentListName = '';
                availableStudents = [];
                selectedStudents = [];
                currentNameElement.textContent = translations[currentLanguage].pleaseSelectList;
                updateSelectedList();
                updateManualStudentSelector();
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users'));
            
            // 检查是否是管理员查看其他用户的名单
            if (listName.includes(' - ')) {
                const [owner, actualListName] = listName.split(' - ');
                currentListName = listName;
                availableStudents = [...users[owner].lists[actualListName]];
            } else {
                const currentUserData = users[currentUser];
                currentListName = listName;
                availableStudents = [...currentUserData.lists[listName]];
            }
            
            selectedStudents = [];
            currentNameElement.textContent = translations[currentLanguage].readyText;
            updateSelectedList();
            updateManualStudentSelector();
        }

        // 随机选择名字
        function getRandomNames(count) {
            if (availableStudents.length === 0) {
                return [translations[currentLanguage].allSelectedText];
            }
            
            // 如果请求的数量大于可用学生数，返回所有可用学生
            const actualCount = Math.min(count, availableStudents.length);
            const selected = [];
            const tempAvailable = [...availableStudents];
            
            for (let i = 0; i < actualCount; i++) {
                const randomIndex = Math.floor(Math.random() * tempAvailable.length);
                selected.push(tempAvailable[randomIndex]);
                tempAvailable.splice(randomIndex, 1);
            }
            
            return selected;
        }

        // 开始/停止点名
        function toggleRollCall() {
            if (!currentListName) {
                alert(translations[currentLanguage].pleaseSelectList);
                return;
            }
            
            if (!isRunning) {
                // 开始点名
                if (availableStudents.length === 0) {
                    alert(translations[currentLanguage].allSelectedText);
                    return;
                }
                
                isRunning = true;
                startBtn.textContent = currentLanguage === 'zh' ? '停止点名' : 
                                      currentLanguage === 'en' ? 'Stop Roll Call' : 
                                      'Parar Llamada';
                startBtn.classList.add('running');
                
                // 开始闪烁名字
                intervalId = setInterval(() => {
                    const batchCount = parseInt(batchCountSelector.value);
                    const names = getRandomNames(batchCount);
                    currentNameElement.textContent = names.join(', ');
                }, 100);
            } else {
                // 停止点名
                isRunning = false;
                startBtn.textContent = translations[currentLanguage].startBtn;
                startBtn.classList.remove('running');
                clearInterval(intervalId);
                
                // 确定最终选择的名字
                const selectedNamesText = currentNameElement.textContent;
                
                if (selectedNamesText !== translations[currentLanguage].allSelectedText) {
                    const selectedNames = selectedNamesText.split(', ');
                    
                    // 添加到已选名单
                    selectedNames.forEach(name => {
                        if (name && name !== translations[currentLanguage].allSelectedText) {
                            selectedStudents.push(name);
                            
                            // 从可用名单中移除
                            const index = availableStudents.indexOf(name);
                            if (index > -1) {
                                availableStudents.splice(index, 1);
                            }
                        }
                    });
                    
                    // 更新UI
                    updateSelectedList();
                    updateManualStudentSelector();
                    
                    // 添加选中效果
                    currentNameElement.classList.add('selected');
                    setTimeout(() => {
                        currentNameElement.classList.remove('selected');
                    }, 1000);
                }
            }
        }

        // 重置名单
        function resetList() {
            // 停止点名
            if (isRunning) {
                clearInterval(intervalId);
                isRunning = false;
                startBtn.textContent = translations[currentLanguage].startBtn;
                startBtn.classList.remove('running');
            }
            
            // 重置数据
            if (currentListName) {
                const users = JSON.parse(localStorage.getItem('users'));
                
                // 检查是否是管理员查看其他用户的名单
                if (currentListName.includes(' - ')) {
                    const [owner, actualListName] = currentListName.split(' - ');
                    availableStudents = [...users[owner].lists[actualListName]];
                } else {
                    const currentUserData = users[currentUser];
                    availableStudents = [...currentUserData.lists[currentListName]];
                }
                
                selectedStudents = [];
                
                // 重置UI
                currentNameElement.textContent = translations[currentLanguage].readyText;
                updateSelectedList();
                updateManualStudentSelector();
            }
        }

        // 更新已选名单显示
        function updateSelectedList() {
            if (selectedStudents.length === 0) {
                selectedListElement.innerHTML = `<div class="empty-history">${translations[currentLanguage].emptyHistory}</div>`;
            } else {
                selectedListElement.innerHTML = selectedStudents
                    .map(name => `
                        <div class="selected-item">
                            ${name}
                            <button class="remove-btn" onclick="removeStudent('${name}')">&times;</button>
                        </div>
                    `)
                    .join('');
            }
        }

        // 新建名单
        function newList() {
            listNameInput.value = '';
            namesInput.value = '';
            listSelector.value = '';
            currentListName = '';
            currentNameElement.textContent = translations[currentLanguage].pleaseSelectList;
            updateManualStudentSelector();
        }

        // 保存名单
        function saveList() {
            const listName = listNameInput.value.trim();
            const namesText = namesInput.value.trim();
            
            if (!listName) {
                alert(translations[currentLanguage].listNamePlaceholder);
                return;
            }
            
            if (!namesText) {
                alert(translations[currentLanguage].namesPlaceholder);
                return;
            }
            
            // 处理姓名列表
            const names = namesText.split('\n')
                .map(name => name.trim())
                .filter(name => name !== '');
            
            if (names.length === 0) {
                alert(translations[currentLanguage].namesPlaceholder);
                return;
            }
            
            // 保存名单
            const users = JSON.parse(localStorage.getItem('users'));
            const currentUserData = users[currentUser];
            currentUserData.lists[listName] = names;
            localStorage.setItem('users', JSON.stringify(users));
            updateListSelector();
            
            // 选择新名单
            listSelector.value = listName;
            selectList(listName);
            
            alert(translations[currentLanguage].listSaved);
        }

        // 删除名单
        function deleteList() {
            const listName = listNameInput.value.trim();
            
            if (!listName) {
                alert(translations[currentLanguage].selectListFirst);
                return;
            }
            
            if (!confirm(translations[currentLanguage].confirmDeleteList)) {
                return;
            }
            
            // 删除名单
            const users = JSON.parse(localStorage.getItem('users'));
            const currentUserData = users[currentUser];
            delete currentUserData.lists[listName];
            localStorage.setItem('users', JSON.stringify(users));
            updateListSelector();
            
            // 清空编辑器
            newList();
            
            alert(translations[currentLanguage].listDeleted);
        }

        // 初始化应用
        init();
        
        // 将removeStudent函数设为全局，以便在HTML中使用
        window.removeStudent = removeStudent;
    </script>
</body>
</html>